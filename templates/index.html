<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洋楽ヘルパーくん</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="icon" href="../static/images/music_app_logo.png">
</head>

<body>
    <header>
        <h1>洋楽ヘルパーくん</h1>
    </header>
    <main>
    <form id="transcriptionForm" class="form">
        <label for="youtube_url">YouTubeのリンクを入力してください:</label><br>
        <input type="url" id="youtube_url" name="youtube_url" placeholder="https://www.youtube.com/..." required>
        <button type="submit">文字起こしを開始</button>
    </form>    

    <div id="loading" style="display: none;">
        <div class="fulfilling-square-spinner">
            <div class="spinner-inner"></div>
        </div>
        <h1 class="loading-text"></h1>
    </div>
    
    <div id="result" style="display: none;">
        <div class="result">
            <h3>文字起こし結果:</h3>
            <p id="transcriptionText"></p>
            <a id="downloadLink" href="/download" style="display: none;">文字起こし結果をダウンロード</a>
            <a id="readAloudLink" href="/read-aloud" style="display: none;">文字起こし結果を読み上げ</a>
            <a id="translateLink" href="/translate" style="display: none;">翻訳する</a>
        </div>
    </div>

    {% block content %}
    {% endblock %}
    </main>    

    <script>
        document.getElementById("transcriptionForm").addEventListener("submit", async function (event) {
            event.preventDefault(); // デフォルトのフォーム送信を防ぐ
    
            // ローディング画面を表示し、結果を非表示にする
            document.getElementById("loading").style.display = "block";
            document.getElementById("result").style.display = "none";
    
            // フォームデータを取得
            const formData = new FormData(event.target);
            const url = event.target.action || "/"; // フォーム送信先
    
            try {
                // サーバーに非同期リクエストを送信
                const response = await fetch(url, {
                    method: "POST",
                    body: formData,
                });
    
                // サーバーからのレスポンスを取得
                if (response.ok) {
                    const result = await response.json(); // JSON形式のデータを期待
                    const taskId = result.task_id;
    
                    // タスクの状態をポーリングして確認
                    await pollTaskStatus(taskId);
                } else {
                    document.getElementById("transcriptionText").textContent = "エラーが発生しました。";
                    document.getElementById("result").style.display = "block";
                }
            } catch (error) {
                console.error("エラー:", error);
                document.getElementById("transcriptionText").textContent = "エラーが発生しました。";
                document.getElementById("result").style.display = "block";
            } finally {
                // ローディング画面を非表示にする
                document.getElementById("loading").style.display = "none";
            }
        });

        async function pollTaskStatus(taskId) {
            try {
                let taskStatus = 'PENDING';
                while (taskStatus === 'PENDING' || taskStatus === 'STARTED') {
                    const response = await fetch(`/task-status/${taskId}`);
                    const data = await response.json();
                    taskStatus = data.status;

                    if (taskStatus === 'SUCCESS') {
                        document.getElementById("transcriptionText").textContent = data.result;
                        document.getElementById("downloadLink").style.display = "inline-block";
                        document.getElementById("readAloudLink").style.display = "inline-block";
                        document.getElementById("translateLink").style.display = "inline-block";
                        document.getElementById("result").style.display = "block";
                    } else if (taskStatus === 'FAILURE') {
                        document.getElementById("transcriptionText").textContent = "処理に失敗しました。";
                        document.getElementById("result").style.display = "block";
                    } else {
                        // 進捗中の場合は少し待ってから再確認
                        await new Promise(resolve => setTimeout(resolve, 3000));
                    }
                }
            } catch (error) {
                console.error("タスクステータスの取得エラー:", error);
                document.getElementById("transcriptionText").textContent = "エラーが発生しました。";
                document.getElementById("result").style.display = "block";
            }
        }
    </script>
</body>
</html>
